<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手写一个 loader | webpack从入门到精通</title>
    <meta name="description" content="讲解webpack相关知识点">
    
    
    <link rel="preload" href="/webpack-docs/assets/css/0.styles.d386d2e7.css" as="style"><link rel="preload" href="/webpack-docs/assets/js/app.523ca243.js" as="script"><link rel="preload" href="/webpack-docs/assets/js/8.ef513609.js" as="script"><link rel="prefetch" href="/webpack-docs/assets/js/10.a759a65e.js"><link rel="prefetch" href="/webpack-docs/assets/js/11.4231ba87.js"><link rel="prefetch" href="/webpack-docs/assets/js/12.0d5f9ecf.js"><link rel="prefetch" href="/webpack-docs/assets/js/2.ffe410d0.js"><link rel="prefetch" href="/webpack-docs/assets/js/3.a9a8433f.js"><link rel="prefetch" href="/webpack-docs/assets/js/4.25c78323.js"><link rel="prefetch" href="/webpack-docs/assets/js/5.3323bb1b.js"><link rel="prefetch" href="/webpack-docs/assets/js/6.d46bfe17.js"><link rel="prefetch" href="/webpack-docs/assets/js/7.eecfade2.js"><link rel="prefetch" href="/webpack-docs/assets/js/9.da414fd4.js">
    <link rel="stylesheet" href="/webpack-docs/assets/css/0.styles.d386d2e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/webpack-docs/" class="home-link router-link-active"><!----> <span class="site-name">webpack从入门到精通</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/webpack-docs/" class="nav-link">主页</a></div><div class="nav-item"><a href="/webpack-docs/page/" class="nav-link router-link-active">知识库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">github</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Michael-lzg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://juejin.im/user/5b52fd38f265da0f4c6fbd72/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/webpack-docs/" class="nav-link">主页</a></div><div class="nav-item"><a href="/webpack-docs/page/" class="nav-link router-link-active">知识库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">github</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Michael-lzg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://juejin.im/user/5b52fd38f265da0f4c6fbd72/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>webpack专题</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/webpack-docs/page/webpack/基本配置.html" class="sidebar-link">webpack 基本配置</a></li><li><a href="/webpack-docs/page/webpack/知识问答.html" class="sidebar-link">webpack 知识问答</a></li><li><a href="/webpack-docs/page/webpack/对比glup.html" class="sidebar-link">webpack 与 glup</a></li><li><a href="/webpack-docs/page/webpack/搭建项目.html" class="sidebar-link">webpack4 搭建一个项目</a></li><li><a href="/webpack-docs/page/webpack/优化打包.html" class="sidebar-link">webpack 打包优化</a></li><li><a href="/webpack-docs/page/webpack/loader.html" class="active sidebar-link">手写一个 loader</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack-docs/page/webpack/babel.html" class="sidebar-link">babel 指南</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="手写一个-loader"><a href="#手写一个-loader" aria-hidden="true" class="header-anchor">#</a> 手写一个 loader</h1> <p>loader 让 webpack 能够去处理那些非 JavaScript 文件（webpack 自身只理解 JavaScript）。loader 可以将所有类型的文件转换为 webpack 能够处理的有效模块，然后你就可以利用 webpack 的打包能力，对它们进行处理。</p> <h3 id="loader-的特点"><a href="#loader-的特点" aria-hidden="true" class="header-anchor">#</a> loader 的特点</h3> <ul><li>一个 Loader 的职责是单一的，只需要完成一种转换</li> <li>一个 Loader 其实就是一个 Node.js 模块，这个模块需要导出一个函数</li> <li>loader 总是从右到左地被调用。</li></ul> <h3 id="手写一个-loader-2"><a href="#手写一个-loader-2" aria-hidden="true" class="header-anchor">#</a> 手写一个 loader</h3> <p>手写一个 loader 源码，将 'kobe' 转换成 'Black Mamba'。当然大家可以根据自己的需求进行设计。</p> <h4 id="_1、编写-loader"><a href="#_1、编写-loader" aria-hidden="true" class="header-anchor">#</a> 1、编写 loader</h4> <p>在根目录下，新建目录 kobe-loader 作为我们编写 loader 的名称，执行 npm init -y 命令，新建一个模块化项目，然后新建 index.js 文件，相关源码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> content <span class="token operator">&amp;&amp;</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/kobe/gi</span><span class="token punctuation">,</span> <span class="token string">'Black Mamba'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2、注册模块"><a href="#_2、注册模块" aria-hidden="true" class="header-anchor">#</a> 2、注册模块</h4> <p>正常我们安装的 <code>loader</code> 是从 <code>npm</code> 下载安装，但是我们可以在 <code>kobe-loader</code> 目录底下使用 <code>npm link</code> 做到在不发布模块的情况下，将本地的一个正在开发的模块的源码链接到项目的 <code>node_modules</code> 目录下，让项目可以直接使用本地的 <code>npm</code> 模块。</p> <div class="language- extra-class"><pre class="language-text"><code>npm link
</code></pre></div><p>然后在项目根目录执行以下命令，将注册到全局的本地 <code>npm</code> 模块链接到项目的 <code>node_modules</code> 下</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm link kobe-loader
</code></pre></div><p>注册成功后，我们可以在 <code>node_modules</code> 目录下能查找到对应的 <code>loader</code>。</p> <h4 id="_3、在-webpack-中配置-loader"><a href="#_3、在-webpack-中配置-loader" aria-hidden="true" class="header-anchor">#</a> 3、在 webpack 中配置 loader</h4> <p>在 <code>webpack.base.conf.js</code> 加上如下配置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span><span class="token regex">/\.js/</span><span class="token punctuation">,</span>
  loader<span class="token punctuation">:</span> <span class="token string">'kobe-loader'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时，我们在所有 js 文件下书写的 <code>'kobe'</code> 就全部替换成 <code>'Black Mamba'</code>了。</p> <h4 id="_4、配置参数"><a href="#_4、配置参数" aria-hidden="true" class="header-anchor">#</a> 4、配置参数</h4> <p>现在我们是写死的替换文案，加入我想通过配置项来改变，可以在 loader 中做以下调整</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// custom-loader/index.js</span>
<span class="token keyword">var</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> content <span class="token operator">&amp;&amp;</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/kobe/gi</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// webpack.base.conf.js</span>
<span class="token punctuation">{</span>
  test<span class="token punctuation">:</span><span class="token regex">/\.js/</span><span class="token punctuation">,</span>
  use<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    loader<span class="token punctuation">:</span> <span class="token string">'custom-loader'</span><span class="token punctuation">,</span>
    options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token string">'kobe'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="手写一个-plugin"><a href="#手写一个-plugin" aria-hidden="true" class="header-anchor">#</a> 手写一个 plugin</h3> <ul><li>Webpack 在编译过程中，会广播很多事件，例如 run、compile、done、fail 等等，可以查看官网；</li> <li>Webpack 的事件流机制应用了观察者模式，我们编写的插件可以监听 Webpack 事件来触发对应的处理逻辑；</li> <li>插件中可以使用很多 Webpack 提供的 API，例如读取输出资源、代码块、模块及依赖等；</li></ul> <h4 id="_1、编写插件"><a href="#_1、编写插件" aria-hidden="true" class="header-anchor">#</a> 1、编写插件</h4> <p>在根目录下，新建目录 my-plugin 作为我们编写插件的名称，执行 npm init -y 命令，新建一个模块化项目，然后新建 index.js 文件，相关源码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">doneCallback<span class="token punctuation">,</span> failCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存在创建插件实例时传入的回调函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>doneCallback <span class="token operator">=</span> doneCallback
    <span class="token keyword">this</span><span class="token punctuation">.</span>failCallback <span class="token operator">=</span> failCallback
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 成功完成一次完整的编译和输出流程时，会触发 done 事件</span>
    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">,</span> <span class="token parameter">stats</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doneCallback</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 在编译和输出的流程中遇到异常时，会触发 failed 事件</span>
    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'failed'</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">failCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPlugin
</code></pre></div><h4 id="_2、注册模块-2"><a href="#_2、注册模块-2" aria-hidden="true" class="header-anchor">#</a> 2、注册模块</h4> <p>安装以上的方法，我们在 my-plugin 目录底下使用 npm link 做到在不发布模块的情况下，将本地的一个正在开发的模块的源码链接到项目的 node_modules 目录下，让项目可以直接使用本地的 npm 模块。</p> <div class="language- extra-class"><pre class="language-text"><code>npm link
</code></pre></div><p>然后在项目根目录执行以下命令，将注册到全局的本地 npm 模块链接到项目的 node_modules 下</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm link my-plugin
</code></pre></div><p>注册成功后，我们可以在 node_modules 目录下能查找到对应的插件了。</p> <h4 id="_3、配置插件"><a href="#_3、配置插件" aria-hidden="true" class="header-anchor">#</a> 3、配置插件</h4> <p>在 webpack.base.conf.js 加上如下配置</p> <div class="language-js extra-class"><pre class="language-js"><code>plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">MyPlugin</span><span class="token punctuation">(</span>
    <span class="token parameter">stats</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'编译成功!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'编译失败!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><p>执行运行 or 编译命令，就能看到我们的 plugin 起作用了。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/webpack-docs/page/webpack/优化打包.html" class="prev">
          webpack 打包优化
        </a></span> <span class="next"><a href="/webpack-docs/page/webpack/babel.html">
          babel 指南
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/webpack-docs/assets/js/app.523ca243.js" defer></script><script src="/webpack-docs/assets/js/8.ef513609.js" defer></script>
  </body>
</html>
